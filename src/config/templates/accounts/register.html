<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ثبت‌نام</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="" crossorigin="anonymous" />
  <style>
    [dir="rtl"] .fa-layers-text {
      left: auto;
      right: 50%;
      transform: translateX(50%);
    }
  </style>
</head>
<body class="bg-gray-100">
<div class="min-h-screen flex items-center justify-center px-4 sm:px-6 lg:px-8">
  <div class="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden">
    <div class="bg-[#dc2626] py-5 px-6 text-white text-center">
      <h2 class="text-2xl font-semibold">فرم ثبت‌نام</h2>
    </div>
    <div class="p-6 space-y-6">

      <form id="registerForm" class="space-y-4">
        <input type="hidden" id="role" name="role" value="user">

        <!-- نام -->
        <div class="relative">
          <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">نام:</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
              <i class="fa fa-user"></i>
            </span>
            <input type="text" id="first_name" name="first_name" required
                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#dc2626]">
          </div>
          <div class="error text-sm text-red-600 mt-1" id="error_first_name"></div>
        </div>

        <!-- نام خانوادگی -->
        <div class="relative">
          <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">نام خانوادگی:</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
              <i class="fa fa-user"></i>
            </span>
            <input type="text" id="last_name" name="last_name" required
                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#dc2626]">
          </div>
          <div class="error text-sm text-red-600 mt-1" id="error_last_name"></div>
        </div>

        <!-- نام کاربری -->
        <div class="relative">
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">نام کاربری:</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
              <i class="fa fa-id-badge"></i>
            </span>
            <input type="text" id="username" name="username" required
                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#dc2626]">
          </div>
          <div class="error text-sm text-red-600 mt-1" id="error_username"></div>
        </div>

        <!-- ایمیل -->
        <div class="relative">
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">ایمیل:</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
              <i class="fa fa-envelope"></i>
            </span>
            <input type="email" id="email" name="email" required
                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#dc2626]">
          </div>
          <div class="error text-sm text-red-600 mt-1" id="error_email"></div>
        </div>

        <!-- شماره تلفن -->
        <div class="relative">
          <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-1">شماره تلفن:</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
              <i class="fa fa-phone"></i>
            </span>
            <input type="tel" id="phone_number" name="phone_number" required
                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#dc2626]">
          </div>
          <div class="error text-sm text-red-600 mt-1" id="error_phone_number"></div>
        </div>

        <!-- رمز عبور -->
        <div class="relative">
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">رمز عبور:</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
              <i class="fa fa-lock"></i>
            </span>
            <input type="password" id="password" name="password" required
                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#dc2626]">
          </div>
          <div class="error text-sm text-red-600 mt-1" id="error_password"></div>
        </div>

        <!-- تأیید رمز عبور -->
        <div class="relative">
          <label for="password2" class="block text-sm font-medium text-gray-700 mb-1">تأیید رمز عبور:</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
              <i class="fa fa-lock"></i>
            </span>
            <input type="password" id="password2" name="password2" required
                   class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#dc2626]">
          </div>
          <div class="error text-sm text-red-600 mt-1" id="error_password2"></div>
        </div>

        <!-- دکمه‌ها -->
        <div class="flex flex-col gap-3 mt-6">
          <button type="button" id="registerBuyer"
                  class="w-full bg-[#dc2626] text-white py-2 rounded-md hover:bg-[#b91c1c] transition">
            ثبت‌نام خریدار
          </button>
          <button type="button" id="registerSeller"
                  class="w-full bg-[#dc2626] text-white py-2 rounded-md hover:bg-[#b91c1c] transition">
            ثبت‌نام فروشنده
          </button>
        </div>
      </form>

      <!-- فرم ثبت فروشگاه -->
      <div id="createStoreContainer" class="hidden mt-6"></div>
      <div id="generalError" class="text-sm text-red-600 mt-3"></div>

      <!-- لینک ورود -->
      <p class="text-center text-gray-600 mt-4">
        حساب کاربری دارید؟
        <a href="/accounts/login/" class="text-[#dc2626] hover:underline font-medium">ورود</a>
      </p>
    </div>
  </div>
</div>

<script>
  // Utility‌ها
  function getCookie(name) {
    let value = null;
    document.cookie.split(';').forEach(c => {
      let [k,v] = c.trim().split('=');
      if (k===name) value = decodeURIComponent(v);
    });
    return value;
  }
  function clearErrors() {
    document.querySelectorAll('.error').forEach(e=>e.textContent='');
    document.getElementById('generalError').textContent='';
  }
  function showErrors(errors) {
    for (let k in errors) {
      const el = document.getElementById('error_'+k);
      if (el) el.textContent = Array.isArray(errors[k])?errors[k].join(', '):errors[k];
      else document.getElementById('generalError').textContent += errors[k] + '\n';
    }
  }

  // ثبت‌نام
  function submitForm(role, redirect) {
    clearErrors();
    const data = {
      role,
      first_name:   document.getElementById('first_name').value,
      last_name:    document.getElementById('last_name').value,
      username:     document.getElementById('username').value,
      email:        document.getElementById('email').value,
      phone_number: document.getElementById('phone_number').value,
      password:     document.getElementById('password').value,
      password2:    document.getElementById('password2').value,
    };
    if (data.password !== data.password2) {
      document.getElementById('error_password2').textContent = 'رمز عبور و تکرار آن یکسان نیستند.';
      return;
    }
    fetch('/accounts/register_api/', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(data)
    })
    .then(r=>r.json().then(j=>({status:r.status, body:j})))
    .then(({status, body})=>{
      if (status>=200 && status<300) {
        if (redirect==='store') loadStoreForm(body.user_id);
        else window.location=redirect;
      } else {
        showErrors(body);
      }
    })
    .catch(_=>{
      document.getElementById('generalError').textContent = 'خطا در ارتباط با سرور.';
    });
  }

  // فرم فروشگاه
  function loadStoreForm(userId) {
    const c = document.getElementById('createStoreContainer');
    c.classList.remove('hidden');
    c.innerHTML=`
      <h3 class="text-lg font-medium mb-4">ثبت فروشگاه</h3>
      <form id="storeForm" class="space-y-4">
        <input type="hidden" id="user_id" value="${userId}">
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700">نام فروشگاه:</label>
          <input type="text" id="name" required
            class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-[#dc2626]">
          <div class="error text-sm text-red-600 mt-1" id="error_name"></div>
        </div>
        <div>
          <label for="address" class="block text-sm font-medium text-gray-700">آدرس:</label>
          <textarea id="address" rows="3" required
            class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-[#dc2626]"></textarea>
          <div class="error text-sm text-red-600 mt-1" id="error_address"></div>
        </div>
        <button type="button" onclick="submitStore()"
          class="bg-[#dc2626] text-white px-4 py-2 rounded-md hover:bg-[#b91c1c] transition">
          ثبت فروشگاه
        </button>
        <div class="error text-sm text-red-600 mt-2" id="storeError"></div>
      </form>`;
  }

  function submitStore() {
    const data = {
      owner:   document.getElementById('user_id').value,
      name:    document.getElementById('name').value,
      address: document.getElementById('address').value,
    };
    fetch('/api/vendors/record-store/', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(data)
    })
    .then(r=>r.json().then(j=>({status:r.status, body:j})))
    .then(({status, body})=>{
      if (status>=200 && status<300) window.location='/accounts/login/';
      else {
        if (body.name)    document.getElementById('error_name').textContent    = body.name;
        if (body.address) document.getElementById('error_address').textContent = body.address;
        if (body.error)   document.getElementById('storeError').textContent   = body.error;
      }
    })
    .catch(_=>{
      document.getElementById('storeError').textContent = 'خطا در ثبت فروشگاه.';
    });
  }

  // رویدادها
  document.getElementById('registerBuyer')
    .addEventListener('click', ()=>submitForm('user','/accounts/login/'));
  document.getElementById('registerSeller')
    .addEventListener('click', ()=>submitForm('user','store'));
</script>
</body>
</html>
