<!-- cart.html -->
{% extends 'website/base.html' %}

{% block title %}Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <h2 class="text-3xl font-bold mb-6 text-center">ğŸ›’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§</h2>
    <div id="cart-container" class="text-center text-gray-600">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>

    <div class="flex justify-between mt-6">
        <button id="clear-cart" class="bg-red-500 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù„ Ø³Ø¨Ø¯</button>
        <button id="checkout-btn" class="bg-green-500 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
    </div>
</div>


{% block extra_scripts %}
<script>
function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
}

function renderCart(data) {
    const container = document.getElementById('cart-container');
    if (!data.items || !data.items.length) {
        container.innerHTML = '<p>Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>';
        return;
    }

    let html = `<table class="min-w-full bg-white shadow-lg rounded-lg overflow-hidden"><thead><tr>
                    <th class="py-3 px-6 text-left">Ù…Ø­ØµÙˆÙ„</th>
                    <th class="py-3 px-6 text-left">ØªØ¹Ø¯Ø§Ø¯</th>
                    <th class="py-3 px-6 text-left">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                    <th class="py-3 px-6 text-left">Ù‚ÛŒÙ…Øª Ú©Ù„</th>
                    <th class="py-3 px-6 text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr></thead><tbody>`;

    data.items.forEach(item => {
        html += `<tr data-product="${item.product}" class="border-t">
                    <td class="py-3 px-6">${item.product_name}</td>
                    <td class="py-3 px-6"><input type="number" class="qty-input border border-gray-300 rounded-lg p-2 text-center w-16" value="${item.quantity}" min="1"></td>
                    <td class="py-3 px-6">${item.product_price.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
                    <td class="py-3 px-6">${item.item_total_price.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
                    <td class="py-3 px-6 text-center"><button class="delete-btn bg-red-500 text-white py-1 px-4 rounded-lg hover:bg-red-700 transition">Ø­Ø°Ù</button></td>
                </tr>`;
    });

    html += `</tbody><tfoot><tr>
                <td colspan="2" class="py-3 px-6 text-left"><strong>Ù…Ø¬Ù…ÙˆØ¹ ØªØ¹Ø¯Ø§Ø¯:</strong> ${data.total_quantity}</td>
                <td colspan="2" class="py-3 px-6 text-left"><strong>Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ù„Øº:</strong> ${data.total_price.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
                <td class="py-3 px-6"></td>
            </tr></tfoot></table>`;

    container.innerHTML = html;
    setupCartEvents();
}

function setupCartEvents() {
    document.querySelectorAll('.qty-input').forEach(input => {
        input.addEventListener('change', e => {
            const tr = e.target.closest('tr');
            const productId = tr.dataset.product;
            const qty = parseInt(e.target.value) || 1;
            fetch(`/api/cart/${productId}/`, {
                method: 'PATCH',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ quantity: qty })
            })
            .then(() => fetchCart())
            .catch(() => alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯'));
        });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            const productId = e.target.closest('tr').dataset.product;
            fetch(`/api/cart/${productId}/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            })
            .then(() => fetchCart())
            .catch(() => alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù…Ø­ØµÙˆÙ„'));
        });
    });
}

function fetchCart() {
    fetch('/api/cart/', { credentials: 'same-origin' })
        .then(r => {
            if (!r.ok) throw new Error();
            return r.json();
        })
        .then(data => renderCart(data))
        .catch(() => {
            document.getElementById('cart-container').innerHTML = '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</p>';
        });
}

window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('checkout-btn').addEventListener('click', () => {
        window.location.href = '/account/order';
    });

    document.getElementById('clear-cart').addEventListener('click', () => {
        if (confirm('Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù„ Ø³Ø¨Ø¯ØŸ')) {
            fetch('/api/cart/clear/', {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            })
            .then(() => fetchCart())
            .catch(() => alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø³Ø¨Ø¯'));
        }
    });

    fetchCart();
});
</script>
{% endblock %}
{% endblock %}
