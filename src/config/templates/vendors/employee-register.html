{% extends 'vendors/base.html' %}

{% block title %}ثبت‌نام و اطلاعات کارمند{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
    <!-- Header with elegant gradient -->
    <div class="bg-gradient-to-r from-indigo-700 to-indigo-900 px-6 py-5">
      <h2 class="text-2xl font-bold text-white text-center">فرم ثبت‌نام کارمند</h2>
    </div>

    <div class="p-8">
      <form id="employeeRegistrationForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- First Name -->
          <div>
            <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1.5">نام:</label>
            <div class="relative rounded-lg shadow-sm border border-gray-200 hover:border-indigo-300 transition-colors">
              <input type="text" id="first_name" name="first_name" required
                class="block w-full pr-10 border-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg py-3 px-4 transition duration-200 ease-in-out bg-gray-50">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
            </div>
            <div class="text-rose-600 text-xs mt-1.5" id="error_first_name"></div>
          </div>

          <!-- Last Name -->
          <div>
            <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1.5">نام خانوادگی:</label>
            <div class="relative rounded-lg shadow-sm border border-gray-200 hover:border-indigo-300 transition-colors">
              <input type="text" id="last_name" name="last_name" required
                class="block w-full pr-10 border-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg py-3 px-4 transition duration-200 ease-in-out bg-gray-50">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
            </div>
            <div class="text-rose-600 text-xs mt-1.5" id="error_last_name"></div>
          </div>

          <!-- Username -->
          <div>
            <label for="username" class="block text-sm font-medium text-gray-700 mb-1.5">نام کاربری:</label>
            <div class="relative rounded-lg shadow-sm border border-gray-200 hover:border-indigo-300 transition-colors">
              <input type="text" id="username" name="username" required
                class="block w-full pr-10 border-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg py-3 px-4 transition duration-200 ease-in-out bg-gray-50">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
            </div>
            <div class="text-rose-600 text-xs mt-1.5" id="error_username"></div>
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1.5">ایمیل:</label>
            <div class="relative rounded-lg shadow-sm border border-gray-200 hover:border-indigo-300 transition-colors">
              <input type="email" id="email" name="email" required
                class="block w-full pr-10 border-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg py-3 px-4 transition duration-200 ease-in-out bg-gray-50">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
              </div>
            </div>
            <div class="text-rose-600 text-xs mt-1.5" id="error_email"></div>
          </div>

          <!-- Phone Number -->
          <div>
            <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-1.5">شماره تلفن:</label>
            <div class="relative rounded-lg shadow-sm border border-gray-200 hover:border-indigo-300 transition-colors">
              <input type="text" id="phone_number" name="phone_number" required
                class="block w-full pr-10 border-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg py-3 px-4 transition duration-200 ease-in-out bg-gray-50">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
              </div>
            </div>
            <div class="text-rose-600 text-xs mt-1.5" id="error_phone_number"></div>
          </div>

          <!-- Password -->
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1.5">رمز عبور:</label>
            <div class="relative rounded-lg shadow-sm border border-gray-200 hover:border-indigo-300 transition-colors">
              <input type="password" id="password" name="password" required
                class="block w-full pr-10 border-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg py-3 px-4 transition duration-200 ease-in-out bg-gray-50">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
            </div>
            <div class="text-rose-600 text-xs mt-1.5" id="error_password"></div>
          </div>

          <!-- Confirm Password -->
          <div>
            <label for="password2" class="block text-sm font-medium text-gray-700 mb-1.5">تکرار رمز عبور:</label>
            <div class="relative rounded-lg shadow-sm border border-gray-200 hover:border-indigo-300 transition-colors">
              <input type="password" id="password2" name="password2" required
                class="block w-full pr-10 border-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg py-3 px-4 transition duration-200 ease-in-out bg-gray-50">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
            </div>
            <div class="text-rose-600 text-xs mt-1.5" id="error_password2"></div>
          </div>
        </div>

        <div class="text-center text-rose-600 text-sm" id="generalError"></div>

        <div class="pt-2">
          <button type="button" id="registerEmployee"
            class="w-full py-3 px-6 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-semibold rounded-lg shadow-md transition duration-200 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            ثبت‌نام
          </button>
        </div>
      </form>

      <div id="employeeRecordContainer" class="mt-10 hidden">
        <div class="border-t border-gray-200 pt-8">
          <div class="bg-gradient-to-r from-teal-600 to-teal-800 px-6 py-4 rounded-t-lg">
            <h3 class="text-xl font-bold text-white text-center">ثبت اطلاعات کارمند</h3>
          </div>

          <div class="bg-gray-50 p-6 rounded-b-lg border border-gray-200 border-t-0">
            <form id="employeeRecordForm" class="space-y-6">
              <input type="hidden" id="employee_user_id">

              <div>
                <label for="position" class="block text-sm font-medium text-gray-700 mb-1.5">سمت:</label>
                <select id="position" name="position" required
                  class="block w-full border-gray-200 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 rounded-lg py-3 px-4 transition duration-200 ease-in-out shadow-sm bg-white hover:border-teal-300">
                  <option value="operator">اپراتور</option>
                  <option value="manager">مدیر</option>
                </select>
                <div class="text-rose-600 text-xs mt-1.5" id="error_position"></div>
              </div>

              <div class="text-center text-rose-600 text-sm" id="employeeRecordError"></div>

              <div class="pt-2">
                <button type="button" id="submitEmployeeRecordBtn"
                  class="w-full py-3 px-6 bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white font-semibold rounded-lg shadow-md transition duration-200 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
                  ثبت اطلاعات کارمند
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// JavaScript code remains exactly the same as provided
document.addEventListener('DOMContentLoaded', function () {
    function getCSRFToken() {
        return '{{ csrf_token }}';
    }

    function clearErrors() {
        document.querySelectorAll('.text-rose-600').forEach(el => el.textContent = '');
    }

    function showErrors(errors, containerId = null) {
        if (containerId) {
            const container = document.getElementById(containerId);
            container.textContent = '';
            for (let key in errors) {
                container.textContent += `${key}: ${Array.isArray(errors[key]) ? errors[key].join(', ') : errors[key]}\n`;
            }
        } else {
            for (let key in errors) {
                const target = document.getElementById(`error_${key}`);
                if (target) {
                    target.textContent = Array.isArray(errors[key]) ? errors[key].join(', ') : errors[key];
                } else {
                    document.getElementById("generalError").textContent += `${key}: ${errors[key]}\n`;
                }
            }
        }
    }

    function submitEmployeeRegistration() {
        clearErrors();
        document.getElementById("generalError").textContent = '';

        const data = {
            first_name: document.getElementById("first_name").value,
            last_name: document.getElementById("last_name").value,
            username: document.getElementById("username").value,
            email: document.getElementById("email").value,
            phone_number: document.getElementById("phone_number").value,
            password: document.getElementById("password").value,
            password2: document.getElementById("password2").value,
        };

        if (data.password !== data.password2) {
            document.getElementById("error_password2").textContent = "رمز عبور و تکرار آن یکسان نیستند.";
            return;
        }

        fetch('/api/vendors/register-employee/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(data),
        })
        .then(async response => {
            const resData = await response.json();
            if (response.ok) {
                const userId = resData.user_id;
                if (userId) {
                    loadEmployeeRecordForm(userId);
                } else {
                    document.getElementById("generalError").textContent = "شناسه کاربر دریافت نشد.";
                }
            } else {
                showErrors(resData);
            }
        })
        .catch(error => {
            console.error("Registration error:", error);
            document.getElementById("generalError").textContent = "مشکلی در ارتباط با سرور پیش آمد.";
        });
    }

    function loadEmployeeRecordForm(userId) {
        const container = document.getElementById("employeeRecordContainer");
        container.classList.remove('hidden');
        document.getElementById("employee_user_id").value = userId;
    }

    function submitEmployeeRecord() {
        clearErrors();
        const userId = document.getElementById("employee_user_id").value;
        const position = document.getElementById("position").value;

        fetch(`/api/vendors/record-employee/?user_id=${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ position }),
        })
        .then(async response => {
            const resData = await response.json();
            if (response.ok) {
                alert("اطلاعات کارمند با موفقیت ثبت شد.");
                window.location.href = "/api/vendors/employees/";
            } else {
                showErrors(resData, "employeeRecordError");
            }
        })
        .catch(error => {
            console.error("Employee record error:", error);
            document.getElementById("employeeRecordError").textContent = "خطایی در ثبت اطلاعات کارمند پیش آمد.";
        });
    }

    document.getElementById("registerEmployee").addEventListener("click", function (e) {
        e.preventDefault();
        submitEmployeeRegistration();
    });

    document.getElementById("submitEmployeeRecordBtn").addEventListener("click", function (e) {
        e.preventDefault();
        submitEmployeeRecord();
    });
});
</script>
{% endblock %}
